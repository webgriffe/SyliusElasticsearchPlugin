<?php

declare(strict_types=1);

namespace Webgriffe\SyliusElasticsearchPlugin\Pagerfanta;

use Pagerfanta\Adapter\AdapterInterface;
use RuntimeException;
use Webgriffe\SyliusElasticsearchPlugin\Client\ClientInterface;
use Webgriffe\SyliusElasticsearchPlugin\Mapper\QueryResultMapperInterface;
use Webgriffe\SyliusElasticsearchPlugin\Model\QueryResult;
use Webgriffe\SyliusElasticsearchPlugin\Model\QueryResultInterface;
use Webgriffe\SyliusElasticsearchPlugin\Model\ResponseInterface;

/**
 * @implements AdapterInterface<ResponseInterface>
 */
abstract class AbstractElasticsearchQueryAdapter implements AdapterInterface
{
    private ?QueryResultInterface $queryResult = null;

    /** @var int<0,max>|null */
    private ?int $nbResults = null;

    /**
     * @param array<array-key, string> $indexes
     */
    public function __construct(
        private readonly ClientInterface $client,
        private readonly QueryResultMapperInterface $queryResultMapper,
        private readonly array $indexes,
    ) {
    }

    abstract protected function getCountQuery(): array;

    /**
     * @param int<1,10_000> $size
     */
    abstract protected function getQuery(int $page, int $size): array;

    abstract protected function getMinScore(): float;

    public function getNbResults(): int
    {
        if ($this->nbResults !== null) {
            return $this->nbResults;
        }
        $this->nbResults = max(0, $this->client->count(
            $this->getCountQuery(),
            $this->indexes,
            $this->getMinScore(),
        ));

        return $this->nbResults;
    }

    public function getSlice(int $offset, int $length): iterable
    {
        $queryResult = $this->doQuery(
            max(0, $offset),
            max(1, min($length, 10_000)),
        );

        return $queryResult->getHints($offset, $length);
    }

    public function getQueryResult(): QueryResultInterface
    {
        $queryResult = $this->queryResult;
        if ($queryResult === null) {
            throw new RuntimeException('Query has not been already executed! Please, remember to call getCurrentPageResults() on paginator before accessing query results.');
        }

        return $queryResult;
    }

    /**
     * @param int<1,10_000> $size
     */
    private function doQuery(
        int $page,
        int $size,
    ): QueryResultInterface {
        if ($this->queryResult !== null) {
            return $this->queryResult;
        }
        $query = $this->getQuery($page, $size);

        try {
            $esResult = $this->client->query($query, $this->indexes);
        } catch (\Throwable) {
            $this->queryResult = new QueryResult(0, [], []);
            $this->nbResults = 0;

            return $this->queryResult;
        }
        $this->queryResult = $this->queryResultMapper->map($esResult);
        $this->nbResults = max(0, $this->queryResult->getTotalHits());

        return $this->queryResult;
    }
}
